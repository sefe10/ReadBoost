<!doctype html><html lang="tr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Öğrenci</title><link rel="stylesheet" href="style.css"></head><body><div class="container"><div class="card"><h1>Öğrenci Paneli</h1><div><label>Ad Soyad</label><input id="studentName"></div><div style="margin-top:8px"><button id="enterBtn">Giriş</button></div><p id="hello" class="small"></p></div><div id="listCard" style="display:none" class="card"><h2>Başlıklar</h2><div id="list"></div></div><div id="textCard" style="display:none" class="card"><h2 id="tTitle"></h2><p id="tContent" class="mono"></p><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Süre:</strong> <span id="tDuration"></span> sn</div><div><button id="startBtn">Başla</button> <button id="stopBtn" class="secondary" disabled>Bitir</button></div></div><p><strong>Kalan:</strong> <span id="countdown">-</span></p></div><div id="resultCard" style="display:none" class="card"><h2>Sonuç</h2><div id="summary"></div><div id="diffContainer" class="mono" style="margin-top:12px"></div></div></div><script>let student=null,currentText=null,captured=[],recog=null,recognizing=false,timer=null,left=0;document.getElementById('enterBtn').addEventListener('click',async ()=>{const name=document.getElementById('studentName').value.trim();if(!name) return alert('Ad gir');student=name;document.getElementById('hello').textContent='Merhaba, '+student;document.getElementById('listCard').style.display='block'; loadList();}); async function loadList(){ const res=await fetch('/api/texts/withStatus?student_name='+encodeURIComponent(student)); const rows=await res.json(); const wrap=document.getElementById('list'); wrap.innerHTML=''; rows.forEach(r=>{ const read=!!r.reading_id; const status=read?'Okundu':'Okunmadı'; const stats=read?`Kelime ${r.words_read} • Hata ${r.errors} • Hız ${r.wpm} k/dk • ${new Date(r.read_at).toLocaleString()}`:'-'; const action=read?`<a href="reading_detail.html?id=${r.reading_id}"><button>Detay</button></a>`:`<button class="readBtn" data-id="${r.id}">Oku</button>`; const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.padding='8px 0'; div.innerHTML=`<div><strong>${r.title}</strong> <div class='small'>${status} • ${stats}</div></div><div>${action}</div>`; wrap.appendChild(div); }); document.querySelectorAll('.readBtn').forEach(b=>b.addEventListener('click',e=>startReadingForText(e.target.dataset.id))); } async function startReadingForText(id){ const res=await fetch('/api/texts'); const rows=await res.json(); const t=rows.find(x=>String(x.id)===String(id)); if(!t) return alert('Metin bulunamadı'); currentText=t; document.getElementById('tTitle').textContent=currentText.title; document.getElementById('tContent').textContent=currentText.content; document.getElementById('tDuration').textContent=currentText.duration_sec; document.getElementById('textCard').style.display='block'; window.scrollTo(0,document.body.scrollHeight); } function initRecog(){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR) return alert('Tarayıcı desteklemiyor. Chrome önerilir'); const r=new SR(); r.lang='tr-TR'; r.continuous=true; r.interimResults=true; r.onresult=(e)=>{ for(let i=e.resultIndex;i<e.results.length;i++){ const res=e.results[i]; if(res.isFinal) captured.push(res[0].transcript); } }; r.onerror=(e)=>console.log('err',e); r.onend=()=>{ if(recognizing){ try{ r.start(); }catch{} } }; return r; } document.getElementById('startBtn').addEventListener('click',()=>{ if(!student) return alert('Ad gir'); if(!currentText) return alert('Başlık seç'); recog=initRecog(); if(!recog) return; captured=[]; recognizing=true; recog.start(); left=currentText.duration_sec; document.getElementById('countdown').textContent=left; document.getElementById('startBtn').disabled=true; document.getElementById('stopBtn').disabled=false; timer=setInterval(()=>{ left--; document.getElementById('countdown').textContent=left; if(left<=0) stop(); },1000); }); document.getElementById('stopBtn').addEventListener('click', async ()=>{ recognizing=false; if(recog){ try{ recog.stop(); }catch{} } clearInterval(timer); document.getElementById('stopBtn').disabled=true; const transcript=captured.join(' ').trim(); const payload={ student_name:student, text_id:currentText.id, transcript, duration_sec:currentText.duration_sec }; const res=await fetch('/api/readings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const out=await res.json(); document.getElementById('resultCard').style.display='block'; document.getElementById('summary').innerHTML=`<div style="display:flex;gap:8px"><div class="badge">Kelime: ${out.words_read}</div><div class="badge">Hata: ${out.errors}</div><div class="badge">Hız: ${out.wpm} k/dk</div></div>`; document.getElementById('diffContainer').innerHTML=out.detail_html; document.getElementById('startBtn').disabled=false; loadList(); });</script></div></body></html>