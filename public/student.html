<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√ñƒürenci Paneli</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .card {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .card h1, .card h2 {
      margin-top: 0;
    }
    .input-group {
      margin: 15px 0;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      border-color: #007cba;
      outline: none;
    }
    button {
      background: #007cba;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    button:hover {
      background: #005a87;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn-success {
      background: #28a745;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-warning {
      background: #ffc107;
      color: #212529;
    }
    .btn-warning:hover {
      background: #e0a800;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .text-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .text-card {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .text-card:hover {
      border-color: #007cba;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 124, 186, 0.15);
    }
    .text-card.attempted {
      border-color: #28a745;
      background: #f8fff9;
    }
    .text-card h3 {
      margin: 0 0 8px 0;
      color: #333;
    }
    .text-meta {
      font-size: 14px;
      color: #666;
      margin: 8px 0;
    }
    .text-stats {
      background: white;
      border-radius: 6px;
      padding: 8px;
      margin-top: 8px;
      font-size: 12px;
    }
    .stat-item {
      display: inline-block;
      margin-right: 12px;
      font-weight: bold;
    }
    .stat-best {
      color: #28a745;
    }
    .stat-attempts {
      color: #007cba;
    }
    .hidden {
      display: none;
    }
    #readingInterface {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 24px;
    }
    #originalText {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      line-height: 1.6;
      font-size: 18px;
      margin-bottom: 20px;
      min-height: 100px;
    }
    .reading-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .timer {
      font-size: 24px;
      font-weight: bold;
      color: #dc3545;
      background: white;
      padding: 8px 16px;
      border-radius: 8px;
      border: 2px solid #dc3545;
    }
    .timer.warning {
      color: #ffc107;
      border-color: #ffc107;
    }
    .timer.danger {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    #transcriptArea {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      min-height: 100px;
      font-size: 16px;
      line-height: 1.5;
      margin: 20px 0;
    }
    .recording {
      border-color: #dc3545 !important;
      background: #fff5f5 !important;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    .result-card {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .result-value {
      font-size: 28px;
      font-weight: bold;
      color: #007cba;
    }
    .result-label {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }
    .comparison {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 2;
      font-size: 16px;
      border: 2px solid #e9ecef;
    }
    .word-correct {
      background: #d4edda;
      color: #155724;
      padding: 2px 4px;
      border-radius: 4px;
      margin: 0 2px;
      border: 1px solid #c3e6cb;
    }
    .word-error {
      background: #f8d7da;
      color: #721c24;
      padding: 2px 4px;
      border-radius: 4px;
      margin: 0 2px;
      text-decoration: line-through;
      border: 1px solid #f5c6cb;
    }
    .word-missing {
      background: #fff3cd;
      color: #856404;
      padding: 2px 4px;
      border-radius: 4px;
      margin: 0 2px;
      border: 1px solid #ffeaa7;
      font-style: italic;
    }
    .word-extra {
      background: #d1ecf1;
      color: #0c5460;
      padding: 2px 4px;
      border-radius: 4px;
      margin: 0 2px;
      border: 1px solid #b6d7e2;
      font-weight: bold;
    }
    .back-btn {
      background: #6c757d;
      margin-bottom: 20px;
    }
    .back-btn:hover {
      background: #5a6268;
    }
    .recent-readings {
      margin-top: 30px;
    }
    .reading-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .reading-info h4 {
      margin: 0 0 4px 0;
      color: #333;
    }
    .reading-info .meta {
      font-size: 12px;
      color: #666;
    }
    .reading-stats {
      text-align: right;
      font-size: 14px;
    }
    .reading-stats .wpm {
      font-weight: bold;
      color: #007cba;
    }
    .reading-stats .errors {
      color: #dc3545;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Giri≈ü Ekranƒ± -->
    <div id="loginScreen" class="card">
      <h1>üßí √ñƒürenci Paneli</h1>
      <p>Adƒ±nƒ± yazarak okuma alƒ±≈ütƒ±rmalarƒ±na ba≈üla!</p>
      <div class="input-group">
        <label for="studentName">Adƒ±n:</label>
        <input type="text" id="studentName" placeholder="√ñrn: Ahmet Yƒ±lmaz" />
      </div>
      <button onclick="enterStudent()" id="enterBtn">Ba≈üla</button>
    </div>

    <!-- Ana Panel -->
    <div id="mainPanel" class="hidden">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h1 id="welcomeText">Ho≈ü geldin!</h1>
          <button onclick="logout()" class="btn-danger">√áƒ±kƒ±≈ü</button>
        </div>
      </div>

      <!-- Metinler Listesi -->
      <div id="textsSection" class="card">
        <h2>üìö Okuma Metinleri</h2>
        <p>Bir metin se√ß ve okuma alƒ±≈ütƒ±rmasƒ±na ba≈üla!</p>
        <div id="textsGrid" class="text-grid">
          <!-- Metinler buraya y√ºklenecek -->
        </div>
      </div>

      <!-- Son Okumalar -->
      <div id="recentSection" class="card recent-readings hidden">
        <h2>üìà Son Okumalarƒ±m</h2>
        <div id="recentReadings">
          <!-- Son okumalar buraya y√ºklenecek -->
        </div>
      </div>
    </div>

    <!-- Okuma Aray√ºz√º -->
    <div id="readingScreen" class="hidden">
      <div class="card">
        <button onclick="goBackToTexts()" class="back-btn">‚Üê Metinlere D√∂n</button>
        <h2 id="readingTitle">Okuma Alƒ±≈ütƒ±rmasƒ±</h2>
        
        <div id="readingInterface">
          <h3>üìñ Okuyacaƒüƒ±n Metin:</h3>
          <div id="originalText"></div>

          <div class="reading-controls">
            <div id="timer" class="timer">--:--</div>
            <button id="startBtn" onclick="startReading()">üé§ Okumaya Ba≈üla</button>
            <button id="stopBtn" onclick="stopReading()" class="btn-danger hidden">‚èπÔ∏è Durdur</button>
          </div>

          <div id="recordingStatus" class="hidden">
            <p style="text-align: center; color: #dc3545; font-weight: bold;">
              üé§ Kayƒ±t yapƒ±lƒ±yor... Metni sesli okumaya ba≈üla!
            </p>
          </div>

          <div>
            <h3>üéôÔ∏è Senin Okuduƒüun:</h3>
            <div id="transcriptArea">Hen√ºz kayƒ±t ba≈ülamadƒ±...</div>
          </div>
        </div>

        <!-- Sonu√ßlar -->
        <div id="resultsSection" class="hidden">
          <h2>üìä Sonu√ßlarƒ±n</h2>
          
          <div class="results-grid">
            <div class="result-card">
              <div id="wpmResult" class="result-value">0</div>
              <div class="result-label">Kelime/Dakika</div>
            </div>
            <div class="result-card">
              <div id="wordsResult" class="result-value">0</div>
              <div class="result-label">Okunan Kelime</div>
            </div>
            <div class="result-card">
              <div id="errorsResult" class="result-value">0</div>
              <div class="result-label">Hata Sayƒ±sƒ±</div>
            </div>
            <div class="result-card">
              <div id="accuracyResult" class="result-value">0%</div>
              <div class="result-label">Doƒüruluk</div>
            </div>
          </div>

          <div>
            <h3>üîç Metin Kar≈üƒ±la≈ütƒ±rmasƒ±</h3>
            <div id="comparisonArea" class="comparison"></div>
          </div>

          <div style="text-align: center; margin: 20px 0;">
            <button onclick="tryAgain()" class="btn-warning">üîÑ Tekrar Dene</button>
            <button onclick="goBackToTexts()" class="btn-success">‚úÖ Tamamladƒ±m</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentStudent = '';
    let currentText = null;
    let recognition = null;
    let isRecording = false;
    let startTime = null;
    let timeLimit = 0;
    let timerInterval = null;
    let transcript = '';

    // Metni normalize etme fonksiyonu
    function normalizeText(text) {
      return text
        .toLowerCase() // B√ºy√ºk-k√º√ß√ºk harf duyarsƒ±z
        .replace(/[^\w\sƒü√º≈üƒ±√∂√ßƒû√ú≈ûI√ñ√á]/g, ' ') // Noktalama i≈üaretlerini bo≈üluk yap
        .replace(/\s+/g, ' ') // √áoklu bo≈üluklarƒ± tek bo≈üluk yap
        .trim() // Ba≈üƒ±ndaki ve sonundaki bo≈üluklarƒ± temizle
        .split(' ') // Kelimelere ayƒ±r
        .filter(word => word.length > 0); // Bo≈ü kelimeleri filtrele
    }

    // Geli≈ümi≈ü hata hesaplama
    function calculateErrors(originalWords, spokenWords) {
      let errors = 0;
      let skippedWords = [];
      let duplicateWords = [];
      
      let originalIndex = 0;
      let spokenIndex = 0;
      
      while (originalIndex < originalWords.length || spokenIndex < spokenWords.length) {
        // Orijinal metin bitti ama konu≈üma devam ediyor (fazla kelime)
        if (originalIndex >= originalWords.length) {
          errors++;
          duplicateWords.push({
            word: spokenWords[spokenIndex],
            position: spokenIndex,
            type: 'extra'
          });
          spokenIndex++;
          continue;
        }
        
        // Konu≈üma bitti ama orijinal metin devam ediyor (atlanan kelime)
        if (spokenIndex >= spokenWords.length) {
          errors++;
          skippedWords.push({
            word: originalWords[originalIndex],
            position: originalIndex,
            type: 'skipped'
          });
          originalIndex++;
          continue;
        }
        
        // Mevcut kelimeler e≈üle≈üiyor
        if (originalWords[originalIndex] === spokenWords[spokenIndex]) {
          originalIndex++;
          spokenIndex++;
          continue;
        }
        
        // Kelimeler e≈üle≈ümiyor - hangi durumda olduƒüumuzu anlayalƒ±m
        
        // 1. √ñƒürenci bir sonraki kelimeyi s√∂ylemi≈ü olabilir (atlama)
        let foundSkipped = false;
        for (let lookAhead = 1; lookAhead <= Math.min(3, originalWords.length - originalIndex); lookAhead++) {
          if (originalWords[originalIndex + lookAhead] === spokenWords[spokenIndex]) {
            // Atlanan kelimeleri kaydet
            for (let i = 0; i < lookAhead; i++) {
              errors++;
              skippedWords.push({
                word: originalWords[originalIndex + i],
                position: originalIndex + i,
                type: 'skipped'
              });
            }
            originalIndex += lookAhead;
            foundSkipped = true;
            break;
          }
        }
        
        if (foundSkipped) continue;
        
        // 2. √ñƒürenci aynƒ± kelimeyi tekrar s√∂ylemi≈ü olabilir (√ßift okuma)
        let foundDuplicate = false;
        if (spokenIndex > 0 && spokenWords[spokenIndex] === spokenWords[spokenIndex - 1]) {
          // √ñnceki kelime ile aynƒ± - √ßift okuma
          errors++;
          duplicateWords.push({
            word: spokenWords[spokenIndex],
            position: spokenIndex,
            type: 'duplicate'
          });
          spokenIndex++;
          foundDuplicate = true;
        }
        
        if (foundDuplicate) continue;
        
        // 3. √ñƒürenci ilerideki bir kelimeyi s√∂ylemi≈ü olabilir
        let foundAhead = false;
        for (let lookAhead = 1; lookAhead <= Math.min(3, spokenWords.length - spokenIndex); lookAhead++) {
          if (originalWords[originalIndex] === spokenWords[spokenIndex + lookAhead]) {
            // Fazla kelimeleri kaydet
            for (let i = 0; i < lookAhead; i++) {
              errors++;
              duplicateWords.push({
                word: spokenWords[spokenIndex + i],
                position: spokenIndex + i,
                type: 'extra'
              });
            }
            spokenIndex += lookAhead;
            foundAhead = true;
            break;
          }
        }
        
        if (foundAhead) continue;
        
        // 4. Basit kelime hatasƒ±
        errors++;
        originalIndex++;
        spokenIndex++;
      }
      
      return {
        total: errors,
        skipped: skippedWords,
        duplicates: duplicateWords
      };
    }

    // Geli≈ümi≈ü metin kar≈üƒ±la≈ütƒ±rmasƒ± olu≈ütur
    function createComparison(originalWords, spokenWords) {
      let html = '';
      let originalIndex = 0;
      let spokenIndex = 0;
      
      const errorInfo = calculateErrors(originalWords, spokenWords);
      
      // Hata raporunu HTML'e ekle
      if (errorInfo.skipped.length > 0 || errorInfo.duplicates.length > 0) {
        html += '<div style="background:#fff3cd;padding:10px;margin:10px 0;border-radius:5px;border-left:4px solid #ffc107;">';
        html += '<strong>üîç Tespit Edilen Hatalar:</strong><br>';
        
        if (errorInfo.skipped.length > 0) {
          html += `<span style="color:#dc3545">üìù Atlanan kelimeler (${errorInfo.skipped.length}): `;
          html += errorInfo.skipped.map(item => `<strong>${item.word}</strong>`).join(', ');
          html += '</span><br>';
        }
        
        if (errorInfo.duplicates.length > 0) {
          const duplicates = errorInfo.duplicates.filter(item => item.type === 'duplicate');
          const extras = errorInfo.duplicates.filter(item => item.type === 'extra');
          
          if (duplicates.length > 0) {
            html += `<span style="color:#007bff">üîÑ √áift okunan kelimeler (${duplicates.length}): `;
            html += duplicates.map(item => `<strong>${item.word}</strong>`).join(', ');
            html += '</span><br>';
          }
          
          if (extras.length > 0) {
            html += `<span style="color:#6610f2">‚ûï Fazla kelimeler (${extras.length}): `;
            html += extras.map(item => `<strong>${item.word}</strong>`).join(', ');
            html += '</span><br>';
          }
        }
        
        html += '</div>';
      }
      
      // Kelime kelime kar≈üƒ±la≈ütƒ±rma
      html += '<div style="line-height:2;font-size:16px;">';
      
      while (originalIndex < originalWords.length || spokenIndex < spokenWords.length) {
        if (originalIndex >= originalWords.length) {
          // Fazla kelime
          html += `<span class="word-extra" title="Fazla kelime">${spokenWords[spokenIndex]}</span> `;
          spokenIndex++;
        } else if (spokenIndex >= spokenWords.length) {
          // Eksik kelime
          html += `<span class="word-missing" title="Atlanan kelime">${originalWords[originalIndex]}</span> `;
          originalIndex++;
        } else if (originalWords[originalIndex] === spokenWords[spokenIndex]) {
          // Doƒüru kelime
          html += `<span class="word-correct" title="Doƒüru">${originalWords[originalIndex]}</span> `;
          originalIndex++;
          spokenIndex++;
        } else {
          // Hatalƒ± okuma durumlarƒ±
          
          // Atlama kontrol√º
          let foundSkip = false;
          for (let lookAhead = 1; lookAhead <= Math.min(3, originalWords.length - originalIndex); lookAhead++) {
            if (originalWords[originalIndex + lookAhead] === spokenWords[spokenIndex]) {
              // Atlanan kelimeleri i≈üaretle
              for (let i = 0; i < lookAhead; i++) {
                html += `<span class="word-missing" title="Atlanan kelime">${originalWords[originalIndex + i]}</span> `;
              }
              originalIndex += lookAhead;
              foundSkip = true;
              break;
            }
          }
          
          if (foundSkip) continue;
          
          // √áift okuma kontrol√º
          if (spokenIndex > 0 && spokenWords[spokenIndex] === spokenWords[spokenIndex - 1]) {
            html += `<span class="word-extra" title="√áift okunmu≈ü kelime" style="background:#e7f3ff;border-color:#007bff;">${spokenWords[spokenIndex]}</span> `;
            spokenIndex++;
            continue;
          }
          
          // Fazla kelime kontrol√º
          let foundExtra = false;
          for (let lookAhead = 1; lookAhead <= Math.min(3, spokenWords.length - spokenIndex); lookAhead++) {
            if (originalWords[originalIndex] === spokenWords[spokenIndex + lookAhead]) {
              // Fazla kelimeleri i≈üaretle
              for (let i = 0; i < lookAhead; i++) {
                html += `<span class="word-extra" title="Fazla kelime">${spokenWords[spokenIndex + i]}</span> `;
              }
              spokenIndex += lookAhead;
              foundExtra = true;
              break;
            }
          }
          
          if (foundExtra) continue;
          
          // Basit hata
          html += `<span class="word-error" title="Hatalƒ±: '${originalWords[originalIndex]}' yerine '${spokenWords[spokenIndex]}'">${spokenWords[spokenIndex]}</span> `;
          originalIndex++;
          spokenIndex++;
        }
      }
      
      html += '</div>';
      
      return html;
    }

    // Giri≈ü
    function enterStudent() {
      const name = document.getElementById('studentName').value.trim();
      if (!name) {
        alert('L√ºtfen adƒ±nƒ± gir!');
        return;
      }
      
      currentStudent = name;
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainPanel').classList.remove('hidden');
      document.getElementById('welcomeText').textContent = `Ho≈ü geldin, ${name}!`;
      
      loadTexts();
      loadRecentReadings();
    }

    // √áƒ±kƒ±≈ü
    function logout() {
      currentStudent = '';
      currentText = null;
      transcript = '';
      
      document.getElementById('mainPanel').classList.add('hidden');
      document.getElementById('readingScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('studentName').value = '';
      
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      if (timerInterval) {
        clearInterval(timerInterval);
      }
    }

    // Metinleri y√ºkle
    async function loadTexts() {
      try {
        const response = await fetch(`/api/student/${encodeURIComponent(currentStudent)}/texts`);
        const texts = await response.json();
        
        const grid = document.getElementById('textsGrid');
        grid.innerHTML = '';
        
        if (texts.length === 0) {
          grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666; padding: 40px;">Hen√ºz metin eklenmemi≈ü</p>';
          return;
        }

        texts.forEach(text => {
          const card = document.createElement('div');
          card.className = `text-card ${text.total_attempts ? 'attempted' : ''}`;
          card.onclick = () => selectText(text);
          
          let statsHtml = '';
          if (text.total_attempts) {
            statsHtml = `
              <div class="text-stats">
                <span class="stat-item stat-best">En ƒ∞yi: ${text.best_wpm} k/dk</span>
                <span class="stat-item stat-attempts">${text.total_attempts} deneme</span>
                <div style="margin-top: 4px; font-size: 11px; color: #888;">
                  Son: ${new Date(text.last_attempt).toLocaleDateString('tr-TR')}
                </div>
              </div>
            `;
          }
          
          card.innerHTML = `
            <h3>${text.title}</h3>
            <div class="text-meta">
              <strong>S√ºre:</strong> ${text.duration_sec} saniye<br>
              <strong>Kelime Sayƒ±sƒ±:</strong> ~${text.content.split(' ').length} kelime
            </div>
            ${statsHtml}
            ${text.total_attempts ? '<div style="margin-top: 8px; font-size: 12px; color: #28a745; font-weight: bold;">‚úÖ Daha √∂nce denemi≈ü</div>' : '<div style="margin-top: 8px; font-size: 12px; color: #007cba; font-weight: bold;">üÜï Yeni</div>'}
          `;
          
          grid.appendChild(card);
        });
      } catch (error) {
        console.error('Metinleri y√ºkleme hatasƒ±:', error);
      }
    }

    // Son okumalarƒ± y√ºkle
    async function loadRecentReadings() {
      try {
        const response = await fetch(`/api/student/${encodeURIComponent(currentStudent)}/readings`);
        const readings = await response.json();
        
        if (readings.length === 0) {
          document.getElementById('recentSection').classList.add('hidden');
          return;
        }

        document.getElementById('recentSection').classList.remove('hidden');
        const container = document.getElementById('recentReadings');
        container.innerHTML = '';

        readings.forEach(reading => {
          const item = document.createElement('div');
          item.className = 'reading-item';
          
          item.innerHTML = `
            <div class="reading-info">
              <h4>${reading.title}</h4>
              <div class="meta">${new Date(reading.created_at).toLocaleDateString('tr-TR', {
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}</div>
            </div>
            <div class="reading-stats">
              <div class="wpm">${reading.wpm} k/dk</div>
              <div class="errors">${reading.errors} hata</div>
            </div>
          `;
          
          container.appendChild(item);
        });
      } catch (error) {
        console.error('Son okumalarƒ± y√ºkleme hatasƒ±:', error);
      }
    }

    // Metin se√ßimi
    async function selectText(text) {
      currentText = text;
      
      document.getElementById('mainPanel').classList.add('hidden');
      document.getElementById('readingScreen').classList.remove('hidden');
      document.getElementById('readingTitle').textContent = text.title;
      document.getElementById('originalText').textContent = text.content;
      document.getElementById('transcriptArea').textContent = 'Hen√ºz kayƒ±t ba≈ülamadƒ±...';
      
      // Sonu√ß b√∂l√ºm√ºn√º gizle
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('startBtn').classList.remove('hidden');
      document.getElementById('stopBtn').classList.add('hidden');
      document.getElementById('recordingStatus').classList.add('hidden');
      
      timeLimit = text.duration_sec;
      transcript = '';
      
      // Timer'ƒ± sƒ±fƒ±rla
      updateTimer(timeLimit);
    }

    // Metinlere d√∂n
    function goBackToTexts() {
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      document.getElementById('readingScreen').classList.add('hidden');
      document.getElementById('mainPanel').classList.remove('hidden');
      
      // Yeniden y√ºkle (g√ºncel veriler i√ßin)
      loadTexts();
      loadRecentReadings();
    }

    // Okumaya ba≈üla
    function startReading() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Tarayƒ±cƒ±n ses tanƒ±ma √∂zelliƒüini desteklemiyor. Chrome veya Edge kullanmayƒ± dene.');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'tr-TR';

      let finalTranscript = '';
      
      recognition.onstart = () => {
        isRecording = true;
        startTime = Date.now();
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        document.getElementById('recordingStatus').classList.remove('hidden');
        document.getElementById('transcriptArea').classList.add('recording');
        
        startTimer();
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            interimTranscript += transcript;
          }
        }
        
        transcript = finalTranscript + interimTranscript;
        document.getElementById('transcriptArea').textContent = transcript || 'Dinleniyor...';
      };

      recognition.onerror = (event) => {
        console.error('Ses tanƒ±ma hatasƒ±:', event.error);
        stopReading();
      };

      recognition.onend = () => {
        if (isRecording) {
          // S√ºre bitmeden durdu, tekrar ba≈ülat
          recognition.start();
        }
      };

      recognition.start();
    }

    // Okumayƒ± durdur
    function stopReading() {
      isRecording = false;
      
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      document.getElementById('startBtn').classList.remove('hidden');
      document.getElementById('stopBtn').classList.add('hidden');
      document.getElementById('recordingStatus').classList.add('hidden');
      document.getElementById('transcriptArea').classList.remove('recording');
      
      // Sonu√ßlarƒ± hesapla
      calculateResults();
    }

    // Timer ba≈ülat
    function startTimer() {
      let remaining = timeLimit;
      
      timerInterval = setInterval(() => {
        remaining--;
        updateTimer(remaining);
        
        if (remaining <= 10) {
          document.getElementById('timer').classList.add('danger');
        } else if (remaining <= 30) {
          document.getElementById('timer').classList.add('warning');
        }
        
        if (remaining <= 0) {
          stopReading();
        }
      }, 1000);
    }

    // Timer g√ºncelle
    function updateTimer(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      document.getElementById('timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      
      // Renk sƒ±nƒ±flarƒ±nƒ± temizle
      const timer = document.getElementById('timer');
      timer.classList.remove('warning', 'danger');
    }

    // Sonu√ßlarƒ± hesapla (Geli≈ümi≈ü versiyon)
    function calculateResults() {
      if (!currentText || !transcript.trim()) {
        alert('Okuma kaydedilmedi. L√ºtfen tekrar dene.');
        return;
      }

      const readingTime = (Date.now() - startTime) / 1000; // saniye
      
      // Normalize edilmi≈ü kelimeler
      const originalWords = normalizeText(currentText.content);
      const spokenWords = normalizeText(transcript);
      
      // WPM hesapla
      const wpm = Math.round((spokenWords.length / readingTime) * 60);
      
      // Geli≈ümi≈ü hata analizi
      const errorAnalysis = calculateErrors(originalWords, spokenWords);
      const errors = errorAnalysis.total;
      const wordsRead = spokenWords.length;
      const accuracy = wordsRead > 0 ? Math.round(((wordsRead - errors) / wordsRead) * 100) : 0;
      
      // Sonu√ßlarƒ± g√∂ster
      document.getElementById('wpmResult').textContent = wpm;
      document.getElementById('wordsResult').textContent = wordsRead;
      document.getElementById('errorsResult').textContent = errors;
      document.getElementById('accuracyResult').textContent = accuracy + '%';
      
      // Geli≈ümi≈ü kar≈üƒ±la≈ütƒ±rma
      const comparison = createComparison(originalWords, spokenWords);
      document.getElementById('comparisonArea').innerHTML = comparison;
      
      // Sonu√ß b√∂l√ºm√ºn√º g√∂ster
      document.getElementById('resultsSection').classList.remove('hidden');
      
      // Detaylƒ± analiz bilgisi
      console.log('Okuma Analizi:', {
        originalWords: originalWords.length,
        spokenWords: spokenWords.length,
        errors: errors,
        skippedWords: errorAnalysis.skipped,
        duplicates: errorAnalysis.duplicates,
        accuracy: accuracy + '%',
        wpm: wpm
      });
      
      // Sonucu kaydet
      saveReading({
        student_name: currentStudent,
        text_id: currentText.id,
        transcript: transcript.trim(),
        words_read: wordsRead,
        errors: errors,
        wpm: wpm,
        detail_html: comparison
      });
    }

    // Sonucu kaydet
    async function saveReading(data) {
      try {
        const response = await fetch('/api/readings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        console.log('Okuma kaydedildi:', result);
      } catch (error) {
        console.error('Kaydetme hatasƒ±:', error);
      }
    }

    // Tekrar dene
    function tryAgain() {
      // Sonu√ß b√∂l√ºm√ºn√º gizle ve ba≈üa d√∂n
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('transcriptArea').textContent = 'Hen√ºz kayƒ±t ba≈ülamadƒ±...';
      transcript = '';
      updateTimer(timeLimit);
      
      // Timer sƒ±nƒ±flarƒ±nƒ± temizle
      const timer = document.getElementById('timer');
      timer.classList.remove('warning', 'danger');
    }

    // Sayfa y√ºklendiƒüinde
    document.addEventListener('DOMContentLoaded', function() {
      // Enter tu≈üu ile giri≈ü
      document.getElementById('studentName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          enterStudent();
        }
      });
      
      // Tarayƒ±cƒ± desteƒüi kontrol√º
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('Bu tarayƒ±cƒ± ses tanƒ±ma √∂zelliƒüini desteklemiyor.');
      }
    });
  </script>
</body>
</html>